
<script>
let currentStreamUrl = null;

// Get current page context
const pageContext = {
  mode: '{{ mode if mode else "main" }}',
  title: '{{ title }}',
  english_title: '{{ english_title }}',
  year: '{{ year }}',
  media_type: '{{ media_type }}',
  season: {{ season if season else 'null' }},
  episode: {{ episode if episode else 'null' }},
  season_number: {{ season_number if season_number else 'null' }},
  tmdb_id: '{{ tmdb_id }}'
};

// Unified torrent search function
async function searchTorrents(mode) {
  const buttonId = mode + '-search-btn';
  const listId = mode + '-torrent-list';
  const button = document.getElementById(buttonId);
  const list = document.getElementById(listId);

  button.textContent = '‚è≥ Hled√°m torrenty...';
  button.disabled = true;

  list.innerHTML = '<div class="loading">üîç Vyhled√°v√°m torrenty...</div>';
  list.style.display = 'block';

  try {
    let searchData = {};

    if (mode === 'episode') {
      searchData = {
        title: pageContext.english_title || pageContext.title,
        english_title: pageContext.english_title,
        year: '',
        media_type: 'tv',
        season: pageContext.season,
        episode: pageContext.episode
      };
    } else if (mode === 'season') {
      searchData = {
        title: pageContext.english_title || pageContext.title,
        english_title: pageContext.english_title,
        year: '',
        media_type: 'tv',
        season: pageContext.season_number
      };
    } else { // main
      searchData = {
        title: pageContext.english_title || pageContext.title,
        english_title: pageContext.english_title,
        year: pageContext.year,
        media_type: pageContext.media_type
      };
    }

    const response = await fetch('/api/torrents', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify(searchData)
    });

    const torrents = await response.json();
    renderTorrents(torrents, list);
  } catch (error) {
    list.innerHTML = '<div class="torrent-item"><div class="torrent-name" style="color:#ff6b6b;">‚ùå Chyba p≈ôi vyhled√°v√°n√≠: ' + error.message + '</div></div>';
  }

  button.textContent = 'üîÑ Vyhledat znovu';
  button.disabled = false;
}

// Manual search function
async function manualSearch(event, mode) {
  event.preventDefault();

  const queryInput = document.getElementById(mode + '-manual-query');
  const listId = mode + '-manual-torrent-list';
  const list = document.getElementById(listId);

  const query = queryInput.value.trim();
  if (!query) return;

  list.innerHTML = '<div class="loading">üîç Vyhled√°v√°m "' + query + '"...</div>';
  list.style.display = 'block';

  try {
    const searchData = {
      title: query,
      english_title: query,
      year: pageContext.year,
      media_type: pageContext.media_type,
      season: mode === 'episode' ? pageContext.season : (mode === 'season' ? pageContext.season_number : null),
      episode: mode === 'episode' ? pageContext.episode : null
    };

    const response = await fetch('/api/torrents', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify(searchData)
    });

    const torrents = await response.json();
    renderTorrents(torrents, list);
  } catch (error) {
    list.innerHTML = '<div class="torrent-item"><div class="torrent-name" style="color:#ff6b6b;">‚ùå Chyba p≈ôi vyhled√°v√°n√≠: ' + error.message + '</div></div>';
  }
}

// Unified torrent rendering
function renderTorrents(torrents, container) {
  if (torrents.length === 0) {
    container.innerHTML = '<div class="torrent-item"><div class="torrent-name">‚ùå ≈Ω√°dn√© torrenty nebyly nalezeny</div></div>';
    return;
  }

  container.innerHTML = torrents.map(t => `
    <div class="torrent-item">
      <div class="torrent-name">${t.name}</div>
      <div class="torrent-meta">
        <span>üì¶ ${t.size || 'N/A'}</span>
        <span>üå± ${t.seeders || 0} seeders</span>
        <span>üì• ${t.leechers || 0} leechers</span>
        <span>üì° ${t.source}</span>
      </div>
      <button onclick="playTorrentAjax('${encodeURIComponent(t.magnet)}')" class="play-btn">
        ‚ñ∂Ô∏è P≈ôehr√°t
      </button>
    </div>
  `).join('');
}

// Unified magnet submission
async function submitMagnet(event, mode) {
  event.preventDefault();

  const magnetInput = document.getElementById(mode + '-magnet-input');
  const submitBtn = document.getElementById(mode + '-magnet-submit');
  const messagesDiv = document.getElementById(mode + '-stream-messages');

  const magnet = magnetInput.value.trim();
  if (!magnet) return;

  await playTorrentAjax(magnet, submitBtn, messagesDiv, magnetInput);
}

// Unified torrent playing
async function playTorrentAjax(magnetOrEncoded, submitBtn = null, messagesDiv = null, magnetInput = null) {
  const magnet = magnetOrEncoded.startsWith('magnet:') ? magnetOrEncoded : decodeURIComponent(magnetOrEncoded);

  // Find submit button and messages div if not provided
  if (!submitBtn) {
    submitBtn = document.querySelector('.submit-btn');
  }
  if (!messagesDiv) {
    messagesDiv = document.querySelector('.stream-messages');
  }

  if (submitBtn) {
    submitBtn.textContent = '‚è≥ Zpracov√°v√°m torrent...';
    submitBtn.disabled = true;
  }

  if (messagesDiv) {
    messagesDiv.innerHTML = '<div class="loading">üîÑ P≈ôid√°v√°m torrent do TorrServeru...</div>';
  }

  try {
    const response = await fetch('/api/play-torrent', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({ magnet: magnet })
    });

    const result = await response.json();

    if (result.success) {
      if (messagesDiv) {
        messagesDiv.innerHTML = '<div class="success">‚úÖ ' + (result.message || 'Stream je p≈ôipraven!') + '</div>';
      }
      showPlayer(result.stream_url, result.hash, result.warning);
      if (magnetInput) {
        magnetInput.value = '';
      }
    } else {
      if (messagesDiv) {
        messagesDiv.innerHTML = '<div class="error">‚ùå ' + (result.error || 'Nezn√°m√° chyba') + '</div>';
      }
    }
  } catch (error) {
    if (messagesDiv) {
      messagesDiv.innerHTML = '<div class="error">‚ùå S√≠≈•ov√° chyba: ' + error.message + '</div>';
    }
  }

  if (submitBtn) {
    submitBtn.textContent = '‚ñ∂Ô∏è Spustit stream';
    submitBtn.disabled = false;
  }
}

// Show unified player
function showPlayer(streamUrl, hash, warning) {
  currentStreamUrl = streamUrl;

  const playerSection = document.getElementById('video-section');
  const player = document.getElementById('unified-player');
  const infoContent = document.getElementById('stream-info');

  player.innerHTML = `
    <source src="${streamUrl}" type="video/mp4">
    <source src="${streamUrl}" type="application/x-mpegURL">
    <p>V√°≈° prohl√≠≈æeƒç nepodporuje video p≈ôehr√°v√°n√≠.</p>
  `;

  infoContent.innerHTML = `
    <div class="info-item">
      <strong>üí° Stream URL:</strong>
      <a href="${streamUrl}" target="_blank">${streamUrl.substr(0, 50)}...</a>
    </div>
    <div class="info-item">
      <strong>üè† TorrServer:</strong> {{ torrserver_url or TORRSERVER_URL }}
    </div>
    ${hash ? `<div class="info-item"><strong>üì¶ Hash:</strong> ${hash.substr(0, 16)}...</div>` : ''}
    ${warning ? `<div class="warning">‚ö†Ô∏è ${warning}</div>` : ''}
    <div class="info-tip">
      üí° <strong>Tip:</strong> Pokud se stream nenaƒç√≠t√°, poƒçkej 10-30 sekund a klikni "Znovu naƒç√≠st"
    </div>
  `;

  playerSection.style.display = 'block';
  player.load();
}

// Player control functions
function retryStream() {
  if (currentStreamUrl) {
    const player = document.getElementById('unified-player');
    player.load();
    setTimeout(() => player.play(), 1000);
  }
}

function testStream() {
  if (currentStreamUrl) {
    window.open(currentStreamUrl, '_blank');
  }
}

async function checkTorrServer() {
  try {
    const response = await fetch('/api/torrserver-status');
    const status = await response.json();

    const infoDiv = document.getElementById('stream-info');
    const statusHtml = `
      <div class="info-item" style="color: ${status.status === 'online' ? '#28a745' : '#dc3545'};">
        <strong>üè• TorrServer Status:</strong> ${status.status}
      </div>
    `;
    infoDiv.innerHTML = statusHtml + infoDiv.innerHTML;

    setTimeout(() => {
      const statusItem = infoDiv.querySelector('.info-item');
      if (statusItem && statusItem.textContent.includes('Status:')) {
        statusItem.remove();
      }
    }, 5000);
  } catch (error) {
    console.error('Error checking TorrServer status:', error);
  }
}

// Debug function to check page context
console.log('Page context:', pageContext);
</script>